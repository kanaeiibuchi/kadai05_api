<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Basic template</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            background: #8f8f8f;
        }

        h1 {
            padding: 0;
            margin: 0;
            font-size: 100%;
            color: white;
        }

        #map {
            color: whitesmoke;
            font-size: 50%;
        }

        .mouse {
            font-size: 50%;
            background: white;
        }
    </style>
</head>

<body>
    <!-- MAP[START] -->
    <h1>ãŠã§ã‹ã‘ãƒãƒƒãƒ—</h1>
    <div id="map"></div>
    <input type="text" id="uname" name="uname" required>
    <button id="send">ã“ã®å ´æ‰€ã‚’è¨˜æ†¶ã™ã‚‹</button>
    <!-- <button id="remove">è¨˜æ†¶ã‚’å–ªå¤±ã™ã‚‹</button> -->
    <div id="myMap" style='width:100%;height:450px;'></div>
    <div id="logList" style="overflow:auto; height: 450px; "></div>
    <!-- MAP[END] -->
    <!--ç¾åœ¨åœ°æƒ…å ±ã‚’å–å¾—ï¼†ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹-->
    <!--ã€Œã“ã®å ´æ‰€ã‚’è¨˜éŒ²ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ãŠã™ï¼†ãƒãƒƒãƒ—ä¸Šã«ãƒ”ãƒ³ã‚’ç½®ã -->
    <!-- jQuery&GoogleMapsAPI -->
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <!-- /jQuery&GoogleMapsAPI -->
    <!-- [ MapTypeId ] https://msdn.microsoft.com/en-us/library/mt712700.aspx -->
    <script
        src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key='
        async defer></script>
    <script>
        let uname;
        let lat;
        let lon;
        //1ï¼ä½ç½®æƒ…å ±ã®å–å¾—ã«æˆåŠŸã—ãŸæ™‚ã®å‡¦ç†
        function mapsInit(position) {
            //lat=ç·¯åº¦ã€lon=çµŒåº¦ ã‚’å–å¾—
            lat = position.coords.latitude;
            lon = position.coords.longitude;
            $("#map").html("ç·¯åº¦" + lat + ",  " + "çµŒåº¦" + lon);
            const map = new Microsoft.Maps.Map('#myMap', {
                center: new Microsoft.Maps.Location(lat, lon), //Location center position
                mapTypeId: Microsoft.Maps.MapTypeId.load, //Type: [load, aerial,canvasDark,canvasLight,birdseye,grayscale,streetside]
                zoom: 18  //Zoom:1=zoomOut, 20=zoomUp[ 1~20 ]
            });
            let center = map.getCenter()
            let pin = new Microsoft.Maps.Pushpin(center)
            map.entities.push(pin)
        };

        //2ï¼ ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã®å‡¦ç†
        function mapsError(error) {
            let e = "";
            if (error.code == 1) { //1ï¼ä½ç½®æƒ…å ±å–å¾—ãŒè¨±å¯ã•ã‚Œã¦ãªã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šï¼‰
                e = "ä½ç½®æƒ…å ±ãŒè¨±å¯ã•ã‚Œã¦ã¾ã›ã‚“";
            }
            if (error.code == 2) { //2ï¼ç¾åœ¨åœ°ã‚’ç‰¹å®šã§ããªã„
                e = "ç¾åœ¨ä½ç½®ã‚’ç‰¹å®šã§ãã¾ã›ã‚“";
            }
            if (error.code == 3) { //3ï¼ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‰ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã£ãŸå ´åˆ
                e = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‰ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã‚Šã¾ã—ãŸ";
            }
            alert("ã‚¨ãƒ©ãƒ¼ï¼š" + e);
        };

        //3.ä½ç½®æƒ…å ±å–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const set = {
            enableHighAccuracy: true, //ã‚ˆã‚Šé«˜ç²¾åº¦ãªä½ç½®ã‚’æ±‚ã‚ã‚‹
            maximumAge: 20000,        //æœ€å¾Œã®ç¾åœ¨åœ°æƒ…å ±å–å¾—ãŒ20ç§’ä»¥å†…ã§ã‚ã‚Œã°ãã®æƒ…å ±ã‚’å†åˆ©ç”¨ã™ã‚‹è¨­å®š
            timeout: 10000            //10ç§’ä»¥å†…ã«ç¾åœ¨åœ°æƒ…å ±ã‚’å–å¾—ã§ããªã‘ã‚Œã°ã€å‡¦ç†ã‚’çµ‚äº†
        };

        //Main:ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‡¦ç† //getCurrentPosition :or: watchPosition
        function GetMap() {
            navigator.geolocation.getCurrentPosition(mapsInit, mapsError, set);
        }
    </script>

    <!-- ä»¥ä¸‹Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, update, onChildChanged, onChildAdded, remove, onChildRemoved }
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, "map");

        $("#send").on("click", function () {
            // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
            const timestamp = new Date().toISOString();
            uname=$("#uname").val()
            const log = {
                uname:$("#uname").val(),
                lat: $("#lat").val(),
                lon: $("#lon").val(),
                timestamp: timestamp
            }
            if (!uname) {
                alert("ãŠå‡ºã‹ã‘å ´æ‰€ã®åå‰ã‚’ã¤ã‘ã¦ãã ã•ã„")
            }
            else {
                // Firebaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç·¯åº¦çµŒåº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                const newPostRef = push(dbRef);
                set(newPostRef, {
                    name:uname,
                    latitude: lat,
                    longitude: lon,
                    timestamp: timestamp
                })
                // alert("è¨˜æ†¶ã—ã¾ã—ãŸ")
            }
        })

        onChildAdded(dbRef, function (data) {
            const log = data.val();
            console.log(uname)
            const key = data.key; //ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ã‚’å–å¾—
            // ç®‡æ¡æ›¸ãç”¨ã®ãƒªã‚¹ãƒˆè¦ç´ ã‚’ä½œæˆ
            let h = '<li id="' + key + '">' + uname + ':' + + lat + ', ' + lon;
            h += '<span class="remove" data-key="' + key + '">ğŸš®</span></li>';
            // ãƒªã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹
            $("#logList").prepend(h);
        });

        // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#logList").on("click", ".remove", function () {
            const key = $(this).attr("data-key")
            const remove_item = ref(db, "map/" + key)
            //å‰Šé™¤é–¢æ•°
            remove(remove_item)
        })

        // å‰Šé™¤å‡¦ç†ãŒFirebaseã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
        onChildRemoved(dbRef, (data) => {
            $("#" + data.key).remove() //å¯¾è±¡ã‚’å‰Šé™¤
        })

    </script>
</body>

</html>